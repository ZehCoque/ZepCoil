<div class="content-fluid" role="main">

    <div class="header-padding">
      <div class="unselectable-line display-flex header-row" style=" align-items: center" (click)="textFilters.setValue('');textFilters.clearValidators();">

        <div class="el-tag--plain el-col-3">
          Identificação
          <button (click)="initFilter_Text('Identificacao');" [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Identificacao', 'class_msg':sortMessages.forText }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.Identificacao.active && !activeFilters.Identificacao">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Identificacao">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Identificacao.active && activeFilters.Identificacao" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Identificacao.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Identificacao.active && !activeFilters.Identificacao">{{activeSorts.Identificacao.dir}}</mat-icon>
          </button>
      </div>

        <div class="el-tag--plain el-col-4">
            Locatário
            <button (click)="initFilter_Text('Pessoa');" [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Pessoa', 'class_msg':sortMessages.forText }" class="small-icon-button position-absolute" mat-icon-button >
              <mat-icon color="darker-primary" *ngIf="!activeSorts.Pessoa.active && !activeFilters.Pessoa">arrow_drop_down</mat-icon>
              <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Pessoa">filter_alt</mat-icon>
              <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Pessoa.active && activeFilters.Pessoa" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Pessoa.dir}}</mat-icon>
              <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Pessoa.active && !activeFilters.Pessoa">{{activeSorts.Pessoa.dir}}</mat-icon>
            </button>
        </div>

        <div class="el-tag--plain el-col-5">
          Descrição
          <button (click)="initFilter_Text('Descricao');" [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Descricao' , 'class_msg': sortMessages.forText }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.Descricao.active && !activeFilters.Descricao">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Descricao">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Descricao.active && activeFilters.Descricao" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Descricao.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Descricao.active && !activeFilters.Descricao">{{activeSorts.Descricao.dir}}</mat-icon>
          </button>
        </div>

        <div class="el-tag--plain el-col-3">
          Data de Início
          <button [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Data_inicio', 'class_msg':sortMessages.forDates }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.Data_inicio.active && !activeFilters.Data_inicio">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Data_inicio">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Data_inicio.active && activeFilters.Data_inicio" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Data_inicio.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Data_inicio.active && !activeFilters.Data_inicio">{{activeSorts.Data_inicio.dir}}</mat-icon>
          </button>

        </div>

        <div class="el-tag--plain el-col-3">
          Data de Término
            <button [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Data_termino', 'class_msg':sortMessages.forDates }" class="small-icon-button position-absolute" mat-icon-button >
              <mat-icon color="darker-primary" *ngIf="!activeSorts.Data_termino.active && !activeFilters.Data_termino">arrow_drop_down</mat-icon>
              <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Data_termino">filter_alt</mat-icon>
              <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Data_termino.active && activeFilters.Data_termino" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Data_termino.dir}}</mat-icon>
              <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Data_termino.active && !activeFilters.Data_termino">{{activeSorts.Data_termino.dir}}</mat-icon>
            </button>

          </div>

        <div class="el-tag--plain el-col-3">
          Valor
          <button [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Valor', 'class_msg':sortMessages.forNumber }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.Valor.active && !activeFilters.Valor">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Valor">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Valor.active && activeFilters.Valor" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Valor.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Valor.active && !activeFilters.Valor">{{activeSorts.Valor.dir}}</mat-icon>
          </button>
        </div>

        <div class="el-tag--plain el-col-2">
          C.C
          <button (click)="initFilter_Text('CC');" [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'CC', 'class_msg':sortMessages.forText }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.CC.active && !activeFilters.CC">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.CC">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.CC.active && activeFilters.CC" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.CC.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.CC.active && !activeFilters.CC">{{activeSorts.CC.dir}}</mat-icon>
          </button>
        </div>

        <div class="el-tag--plain el-col-2">
          Div. C.C
          <button (click)="initFilter_Text('Div_CC');" [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Div_CC', 'class_msg':sortMessages.forNumber }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.Div_CC.active && !activeFilters.Div_CC">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Div_CC">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Div_CC.active && activeFilters.Div_CC" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Div_CC.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Div_CC.active && !activeFilters.Div_CC">{{activeSorts.Div_CC.dir}}</mat-icon>
          </button>
        </div >

        <div class="el-tag--plain el-col-2">
          Tipo
          <button (click)="initFilter_Text('Tipo');" [matMenuTriggerFor]="dropdown_menu" [matMenuTriggerData]="{ 'column': 'Tipo' , 'class_msg': sortMessages.forText }" class="small-icon-button position-absolute" mat-icon-button >
            <mat-icon color="darker-primary" *ngIf="!activeSorts.Tipo.active && !activeFilters.Tipo">arrow_drop_down</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeFilters.Tipo">filter_alt</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Tipo.active && activeFilters.Tipo" style="font-size: 15px; margin-left: -15px; line-height: 35px;">{{activeSorts.Tipo.dir}}</mat-icon>
            <mat-icon color="darker-primary" style="font-size: 18px" *ngIf="activeSorts.Tipo.active && !activeFilters.Tipo">{{activeSorts.Tipo.dir}}</mat-icon>
          </button>
        </div>

        </div>
    </div>

    <cdk-virtual-scroll-viewport *ngIf="!cdk_empty && !loading; else elseBlock" itemSize="78" (scrolledIndexChange)="scroll_func($event)">

        <div style="height: 78px;" *cdkVirtualFor="let Contrato of Contratos, let i=index"  >

          <mat-card (contextmenu)="onContextMenu($event, Contrato, i)" (click)="viewContrato(Contrato.Identificacao)">
            <mat-card-content >
              <div class="unselectable-line display-flex" style=" align-items: center;height: 36px;">

                <div class="el-tag--plain el-col-3">
                  {{Contrato.Identificacao}}
                </div>

                <div class="el-tag--plain el-col-4">
                  {{Contrato.Pessoa}}
                </div>

                <div class="el-tag--plain el-col-5">
                  {{Contrato.Descricao}}
                </div>

                <div class="el-tag--plain el-col-3" style="align-items: center;">
                      {{ Contrato.Data_inicio | amLocal | amDateFormat: 'DD/MM/YYYY' }}
                  </div>

                  <div class="el-tag--plain el-col-3" style="align-items: center;">
                    {{ Contrato.Data_termino | amLocal | amDateFormat: 'DD/MM/YYYY' }}
                </div>

                <div class="el-tag--plain el-col-3">
                  {{ Contrato.Valor | currency:'BRL'}}
                </div>

                <div class="el-tag--plain el-col-2">
                  {{Contrato.CC}}
                </div>


                <div class="el-tag--plain el-col-2">
                  {{Contrato.Div_CC}}
                </div >

                <div class="el-tag--plain el-col-2">
                  {{Contrato.Tipo | tipoText}}
                </div >

              </div>

            </mat-card-content>

          </mat-card>
        </div>

      </cdk-virtual-scroll-viewport>


      <span class="footer-row">

        <div class="botao-contratos">

          <button mat-raised-button color="primary" (click)="openContratosDialog()">
            <mat-icon>
              add
            </mat-icon>
            Novo contrato
          </button>

        </div>
        <span><button style=" margin-top: 20px;" (click)="clearAllFilters()" mat-raised-button color="warn" type="button"><mat-icon style="font-size: 20px;">delete</mat-icon>Excluir todos os filtros</button></span>
      </span>

      <ng-template #elseBlock>
        <cdk-virtual-scroll-viewport itemSize="94">
          <div *ngIf="!loading" style="padding-top: 20px; display: flex;
          justify-content: center;
          align-items: center;">
            <mat-card class="empty-results-disclaimer">
              <mat-card-content>Nada para mostrar</mat-card-content>

            </mat-card>
          </div>
          <div *ngIf="loading" style="text-align: center;">
            <mat-spinner class="loading-indicator"></mat-spinner>
            <div>Carregando...</div>
          </div>
        </cdk-virtual-scroll-viewport>
      </ng-template>

      <div style="visibility: hidden; position: fixed"
  [style.left]="contextMenuPosition.x"
  [style.top]="contextMenuPosition.y"
  [matMenuTriggerFor]="contextMenu"
  #contextMenuTrigger="matMenuTrigger">
    </div>
  <mat-menu #contextMenu="matMenu" >
    <ng-template matMenuContent let-item="item" let-index = "index">
      <button mat-menu-item (click)="editLine(index)">Editar</button>
      <button mat-menu-item (click)="deleteLine(item,index)">Deletar</button>
    </ng-template>
  </mat-menu>
  <mat-menu #dropdown_menu="matMenu">
    <ng-template  matMenuContent let-column="column" let-class_msg="class_msg">
    <button [matMenuTriggerData]="{ 'values': this.filterValues , 'column' : column}" [matMenuTriggerFor]="filtrar" mat-menu-item>
      <mat-icon>filter_alt</mat-icon>
      Filtrar
    </button>
    <button [matMenuTriggerData]="{ 'column': column, 'class_msg' : class_msg }" [matMenuTriggerFor]="classificar" mat-menu-item>
      <mat-icon>sort</mat-icon>
      Classificar
    </button>
    <button *ngIf="activeFilters[column]" mat-menu-item (click)="clearFilter(column)">
      <mat-icon>clear</mat-icon>
      Excluir filtro
    </button>
  </ng-template>
  </mat-menu>

  <mat-menu #filtrar="matMenu">
    <ng-template  matMenuContent let-values="values" let-column="column" let-class_msg="class_msg">

        <div *ngIf="column === 'Data_inicio' || column === 'Data_termino'; then filtrarElseBlock1; else filtrarElseBlock2"></div>
        <ng-template #filtrarElseBlock1>
          <button mat-menu-item (click)="datasForm.controls.Data1.patchValue(today);filterBySpecial(column,'equals')">
            Hoje
          </button>
          <button mat-menu-item (click)="datasForm.controls.Data1.patchValue(monthStart);datasForm.controls.Data2.patchValue(monthEnd);filterBySpecial(column,'between')">
            Este mês
          </button>
          <button mat-menu-item (click)="datasForm.controls.Data1.patchValue(lastMonthStart);datasForm.controls.Data2.patchValue(lastMonthEnd);filterBySpecial(column,'between')">
            Mês passado
          </button>
          <button [matMenuTriggerFor]="escolher_data" mat-menu-item>
            Data específica
          </button>
          <button [matMenuTriggerFor]="periodo" mat-menu-item>
            Escolher período
          </button>
        </ng-template>

        <ng-template #filtrarElseBlock2>
          <div *ngIf="column === 'Valor'; else filtrarElseBlock4" >
            <button [matMenuTriggerFor]="escolher_valor" [matMenuTriggerData]="{'filter_type' : 'between','num' : 2}" mat-menu-item>
              Entre
            </button>
            <button [matMenuTriggerFor]="escolher_valor" [matMenuTriggerData]="{'filter_type' : 'greater','num' : 1}" mat-menu-item>
              Maior que
            </button>
            <button [matMenuTriggerFor]="escolher_valor" [matMenuTriggerData]="{'filter_type' : 'greater_and_equalTo','num' : 1}" mat-menu-item>
              Maior ou igual que
            </button>
            <button [matMenuTriggerFor]="escolher_valor" [matMenuTriggerData]="{'filter_type' : 'smaller','num' : 1}" mat-menu-item>
              Menor que
            </button>
            <button [matMenuTriggerFor]="escolher_valor" [matMenuTriggerData]="{'filter_type' : 'smaller_and_equalTo','num' : 1}" mat-menu-item>
              Menor ou igual que
            </button>
            <button [matMenuTriggerFor]="escolher_valor" [matMenuTriggerData]="{'filter_type' : 'equals','num' : 1}" mat-menu-item>
              Valor específico
            </button>
          </div>

        <ng-template #filtrarElseBlock4>
          <div *ngIf="column === 'Tipo'; else filtrarElseBlock6" >
            <div *ngFor="let item of this.filterLists.Tipo" (click)="filterBy(column, item)">
              <button mat-menu-item>{{item | tipoText}}</button>
            </div>
          </div>
        </ng-template>


        <mat-menu #filtrarEspec="matMenu">
          <ng-template #filtrarElseBlock6 matMenuContent>

            <div style="display: flex; text-align: center; flex-direction:column">
              <mat-form-field (click)="textFilters.setValue('');initFilter_Text(column);$event.stopPropagation()"  class="form-field context-menu autocomplete" >
                <mat-label>{{column | columnName}}</mat-label>
                <input type="text"
                       placeholder="Pesquisar..."
                       matInput
                       [formControl]="textFilters"
                       [matAutocomplete]="auto">
                <mat-autocomplete
                  autoActiveFirstOption #auto="matAutocomplete">
                  <mat-option  *ngFor="let option of filteredOptionsText | async" [value]="option" >
                    {{option}}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>

              <button mat-raised-button color="primary" (click)="filterBy(column, textFilters.value)" [disabled]="textFilters.value == ''">Confirmar</button>
            </div>
          </ng-template>
        </mat-menu>

        </ng-template>

        </ng-template>

  </mat-menu>

  <mat-menu #escolher_valor="matMenu">
    <form [formGroup]="valorForm">
      <ng-template matMenuContent let-num="num" let-filter_type="filter_type">

        <div  style="display: flex; text-align: center; flex-direction:column">
          <mat-form-field  class="form-field context-menu" (click)="$event.stopPropagation()">
            <mat-label *ngIf="num==2">Valor mínimo</mat-label>
            <mat-label *ngIf="num==1">Valor</mat-label>
            <input formControlName="Valor1" class="noselect" matInput [errorStateMatcher]="errorMatcher"   >
          </mat-form-field>

          <mat-form-field *ngIf="num==2" class="form-field context-menu" (click)="$event.stopPropagation()">
            <mat-label>Valor máximo</mat-label>
            <input formControlName="Valor2" class="noselect" matInput [errorStateMatcher]="errorMatcher"   >
          </mat-form-field>

          <mat-error style="width: 220px;" *ngIf="valueError && num==2">O valor mínimo deve ser menor que o valor máximo</mat-error>

          <button mat-raised-button color="primary" (click)="filterBySpecial('Valor',filter_type)" [disabled]="valueError  && num==2">Confirmar</button>
        </div>

      </ng-template>
    </form>
  </mat-menu>

  <mat-menu #menu_datas="matMenu">
    <ng-template matMenuContent let-column="column">
      <button mat-menu-item (click)="datasForm.controls.Data1.patchValue(today);filterBySpecial(column,'equals')">
        Hoje
      </button>
      <button mat-menu-item (click)="datasForm.controls.Data1.patchValue(monthStart);datasForm.controls.Data2.patchValue(monthEnd);filterBySpecial(column,'between')">
        Este mês
      </button>
      <button mat-menu-item (click)="datasForm.controls.Data1.patchValue(lastMonthStart);datasForm.controls.Data2.patchValue(lastMonthEnd);filterBySpecial(column,'between')">
        Mês passado
      </button>
      <button [matMenuTriggerFor]="escolher_data" [matMenuTriggerData]="{'filter_type' : 'greater', 'column' : column}" mat-menu-item>
        Depois de
      </button>
      <button [matMenuTriggerFor]="escolher_data" [matMenuTriggerData]="{'filter_type' : 'smaller', 'column' : column}" mat-menu-item>
        Antes de
      </button>
      <button [matMenuTriggerFor]="escolher_data" [matMenuTriggerData]="{'filter_type' : 'equals', 'column' : column}" mat-menu-item>
        Data específica
      </button>
      <button [matMenuTriggerFor]="periodo" [matMenuTriggerData]="{'column' : column}" mat-menu-item>
        Escolher período
      </button>


    </ng-template>
  </mat-menu>

  <mat-menu #periodo="matMenu">
    <ng-template matMenuContent let-column="column">
  <form [formGroup]="datasForm">
        <div style="display: flex; text-align: center; flex-direction:column">
          <mat-form-field class="form-field context-menu" (click)="$event.stopPropagation()">
            <mat-label>Início do período</mat-label>
            <input matInput formControlName="Data1" [matDatepicker]="picker_filtrardata_i">
            <mat-datepicker-toggle matSuffix [for]="picker_filtrardata_i"></mat-datepicker-toggle>
            <mat-datepicker #picker_filtrardata_i></mat-datepicker>
          </mat-form-field>


          <mat-form-field class="form-field context-menu" (click)="$event.stopPropagation()">
            <mat-label>Fim do Período</mat-label>
            <input matInput formControlName="Data2" [matDatepicker]="picker_filtrardata_f">
            <mat-datepicker-toggle matSuffix [for]="picker_filtrardata_f"></mat-datepicker-toggle>
            <mat-datepicker #picker_filtrardata_f></mat-datepicker>
          </mat-form-field>

          <mat-error style="width: 220px;" *ngIf="dateError">A data do fim do período precisa ser maior que a do início.</mat-error>

          <button (click)="filterBySpecial(column,'between')" mat-raised-button color="primary" [disabled]="dateError">Confirmar</button>
        </div>
      </form>
    </ng-template>
  </mat-menu>

  <mat-menu #escolher_data="matMenu">
    <ng-template matMenuContent let-column="column" let-filter_type="filter_type">
      <form [formGroup]="datasForm">
        <div style="display: flex; text-align: center; flex-direction:column">
          <mat-form-field class="form-field context-menu" (click)="$event.stopPropagation()">
            <mat-label>Data</mat-label>
            <input matInput formControlName="Data1" [matDatepicker]="picker_filtrardata">
            <mat-datepicker-toggle matSuffix [for]="picker_filtrardata"></mat-datepicker-toggle>
            <mat-datepicker #picker_filtrardata></mat-datepicker>
          </mat-form-field>

          <button (click)="filterBySpecial(column,filter_type)" mat-raised-button color="primary">Confirmar</button>
        </div>
      </form>
    </ng-template>
  </mat-menu>

  <mat-menu  #classificar="matMenu">
    <ng-template  matMenuContent let-column="column" let-class_msg="class_msg">
    <button mat-menu-item (click)="sortBy(column, 'ASC')"><mat-icon>arrow_downward</mat-icon>{{class_msg.up}}</button>
    <button mat-menu-item (click)="sortBy(column, 'DESC')"><mat-icon>arrow_upward</mat-icon>{{class_msg.down}}</button>
  </ng-template>
  </mat-menu>

 </div>



